                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>256-bit Private Key Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .key-display {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #495057;
        }

        .key-display.has-key {
            background: #e8f5e8;
            border-color: #28a745;
            color: #155724;
        }

        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            font-weight: 500;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 0.9em;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .copy-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .copy-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .mnemonic-display {
            background: #f0f8ff;
            border: 2px dashed #4a90e2;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .mnemonic-display h3 {
            color: #2c5aa0;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2em;
        }

        .mnemonic-text {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            line-height: 1.8;
            color: #2c5aa0;
            word-break: break-word;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
        }

        .public-key-display {
            background: #f0f8f0;
            border: 2px dashed #28a745;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .public-key-display h3 {
            color: #155724;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2em;
        }

        .public-key-text {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            color: #155724;
            word-break: break-all;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
        }

        .did-key-display {
            background: #f8f0ff;
            border: 2px dashed #6f42c1;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .did-key-display h3 {
            color: #4a2c7a;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2em;
        }

        .did-key-text {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            color: #4a2c7a;
            word-break: break-all;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #d1c4e9;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .restore-section {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .restore-section h3 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .restore-subtitle {
            color: #856404;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .mnemonic-input-container {
            margin: 15px 0;
        }

        .mnemonic-input-container textarea {
            width: 100%;
            max-width: 600px;
            padding: 15px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            background: white;
        }

        .mnemonic-input-container textarea:focus {
            outline: none;
            border-color: #ff8c00;
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
        }

        .restore-button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .restore-btn {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 12px 24px;
            font-size: 1em;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .restore-btn:hover {
            background: #ff8c00;
            transform: translateY(-1px);
        }

        .restore-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .clear-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1em;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            text-align: left;
        }

        .info h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .info p {
            color: #424242;
            line-height: 1.6;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            display: flex;
            justify-content: center;
            margin: 30px 0 20px 0;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .tab-btn:hover {
            color: #495057;
            background-color: #f8f9fa;
        }

        .tab-btn.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background-color: #f8f9fa;
        }

        .tab-content {
            position: relative;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* DID:PLC Form Styles */
        .plc-form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .plc-form-container h2 {
            color: #495057;
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.8em;
        }

        .plc-subtitle {
            text-align: center;
            color: #6c757d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .plc-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .did-input-group {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .did-input-group input {
            flex: 1;
        }

        .fetch-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .fetch-btn:hover {
            background: linear-gradient(135deg, #20c997, #17a2b8);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .fetch-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .rotation-key-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .rotation-key-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .remove-rotation-key-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-rotation-key-btn:hover {
            background: #c82333;
        }
        
        #add-rotation-key-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
        }
        
        #add-rotation-key-btn:hover {
            background: #218838;
        }
        
        .also-known-as-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .also-known-as-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .remove-also-known-as-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-also-known-as-btn:hover {
            background: #c82333;
        }
        
        #add-also-known-as-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
        }
        
        #add-also-known-as-btn:hover {
            background: #218838;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-help {
            display: block;
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 5px;
            font-style: italic;
        }

        .form-button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .submit-btn:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .plc-result {
            background: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            text-align: center;
        }

        .plc-result h3 {
            color: #155724;
            margin-bottom: 15px;
        }

        .plc-result-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            margin-bottom: 15px;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }

        .plc-debug {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            text-align: center;
        }

        .plc-debug h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .plc-debug-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ffeaa7;
            margin-bottom: 15px;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Cryptographic Key Generator</h1>
        <p class="subtitle">Generate secure 256-bit private keys, BIP39 mnemonics, secp256k1 public keys, and DID keys in your browser</p>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn active" id="keygen-tab" data-tab="keygen">
                üîë Key Generation
            </button>
            <button class="tab-btn" id="didplc-tab" data-tab="didplc">
                üÜî DID:PLC Entry
            </button>
            <button class="tab-btn" id="createaccount-tab" data-tab="createaccount">
                üë§ Create Account
            </button>
        </div>
        
        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Key Generation Tab -->
            <div class="tab-pane active" id="keygen-pane">
        
        <div class="key-display" id="keyDisplay">
            Click "Generate Key" to create a new 256-bit private key
        </div>
        
        <div class="mnemonic-display" id="mnemonicDisplay" style="display: none;">
            <h3>üî§ BIP39 Mnemonic Phrase</h3>
            <div class="mnemonic-text" id="mnemonicText"></div>
        </div>
        
        <div class="public-key-display" id="publicKeyDisplay" style="display: none;">
            <h3>üîë secp256k1 Public Key</h3>
            <div class="public-key-text" id="publicKeyText"></div>
        </div>
        
        <div class="did-key-display" id="didKeyDisplay" style="display: none;">
            <h3>üÜî DID Key</h3>
            <div class="did-key-text" id="didKeyText"></div>
        </div>
        
        <div class="button-group">
            <button class="generate-btn" id="generateBtn">
                Generate New Key
            </button>
            
            <button class="copy-btn" id="copyBtn" disabled>
                Copy Key
            </button>
            
            <button class="copy-btn" id="copyMnemonicBtn" disabled>
                Copy Mnemonic
            </button>
            
            <button class="copy-btn" id="copyPublicKeyBtn" disabled>
                Copy Public Key
            </button>
            
            <button class="copy-btn" id="copyDidKeyBtn" disabled>
                Copy DID Key
            </button>
        </div>
        
        <div class="restore-section">
            <h3>üîÑ Restore from Mnemonic</h3>
            <p class="restore-subtitle">Enter a 24-word BIP39 mnemonic phrase to restore the private key</p>
            
            <div class="mnemonic-input-container">
                <textarea 
                    id="mnemonicInput" 
                    placeholder="Enter your 24-word mnemonic phrase here..."
                    rows="3"
                ></textarea>
            </div>
            
            <div class="restore-button-group">
                <button class="restore-btn" id="restoreBtn">
                    Restore Private Key
                </button>
                
                <button class="clear-btn" id="clearBtn">
                    Clear
                </button>
            </div>
        </div>
        
        <div class="info">
            <h3>‚ÑπÔ∏è About This Tool</h3>
            <p>
                This tool generates cryptographically secure 256-bit private keys using the Web Crypto API. 
                The key is generated entirely in your browser and never transmitted over the network. 
                Each key is unique and suitable for cryptographic operations. The tool also generates 
                a corresponding BIP39 mnemonic phrase for easier backup and recovery, computes the 
                secp256k1 public key for use in blockchain applications, and formats the public key 
                as a DID key for decentralized identity use cases. You can also restore a private 
                key from a valid BIP39 mnemonic phrase.
            </p>
        </div>
        
        <div class="status"></div>
            </div>
            
            <!-- DID:PLC Entry Tab -->
            <div class="tab-pane" id="didplc-pane">
                <div class="plc-form-container">
                    <h2>üÜî DID:PLC Entry Form</h2>
                    <p class="plc-subtitle">Create a DID:PLC entry with all required fields for decentralized identity</p>
                    
                    <form id="didplc-form" class="plc-form">
                        <div class="form-group">
                            <label for="plc-did">DID Identifier</label>
                            <div class="did-input-group">
                                <input type="text" id="plc-did" name="did" placeholder="did:plc:example" required>
                                <button type="button" class="fetch-btn" id="fetch-did-btn">
                                    üîç Fetch Record
                                </button>
                            </div>
                            <small class="form-help">The decentralized identifier (e.g., did:plc:abc123) - click "Fetch Record" to load existing data</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Rotation Keys</label>
                            <div id="rotation-keys-container">
                                <div class="rotation-key-group">
                                    <input type="text" class="rotation-key-input" placeholder="Enter rotation key" required>
                                    <button type="button" class="remove-rotation-key-btn" style="display: none;">Remove</button>
                                </div>
                            </div>
                            <button type="button" id="add-rotation-key-btn">Add Rotation Key</button>
                            <small class="form-help">Public keys used for key rotation</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="plc-atproto-verification-method">ATProto Verification Method</label>
                            <input type="text" id="plc-atproto-verification-method" name="atprotoVerificationMethod" placeholder="Enter ATProto verification method (did:key:...)" required>
                            <small class="form-help">The verification method used for ATProto authentication</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="plc-pds-endpoint">PDS Endpoint</label>
                            <input type="text" id="plc-pds-endpoint" name="pdsEndpoint" placeholder="Enter PDS endpoint URL (e.g., https://bsky.social)" required>
                            <small class="form-help">The ATProto Personal Data Server endpoint URL</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Also Known As</label>
                            <div id="also-known-as-container">
                                <div class="also-known-as-group">
                                    <input type="text" class="also-known-as-input" placeholder="Enter alternative identifier (e.g., at://goat.navy)">
                                    <button type="button" class="remove-also-known-as-btn" style="display: none;">Remove</button>
                                </div>
                            </div>
                            <button type="button" id="add-also-known-as-btn">Add Also Known As</button>
                            <small class="form-help">Optional: Alternative identifiers or handles</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="plc-previous-update">Previous Update</label>
                            <input type="text" id="plc-previous-update" name="previousUpdate" placeholder="Previous update operation CID (if applicable)">
                            <small class="form-help">Optional: CID of the previous update operation for operation history</small>
                        </div>
                        
                        <div class="form-button-group">
                            <button type="submit" class="submit-btn" id="submit-plc-btn">
                                Create DID:PLC Entry
                            </button>
                            <button type="button" class="clear-btn" id="clear-plc-btn">
                                Clear Form
                            </button>
                        </div>
                    </form>
                    
                    <div class="plc-result" id="plc-result" style="display: none;">
                        <h3>üìã Generated DID:PLC Entry</h3>
                        <div class="plc-result-content" id="plc-result-content"></div>
                        <button class="copy-btn" id="copy-plc-result-btn">
                            Copy DID:PLC Entry
                        </button>
                    </div>
                    
                    <div class="plc-debug" id="plc-debug" style="display: none;">
                        <h3>üîç Raw Audit Log (Debug)</h3>
                        <div class="plc-debug-content" id="plc-debug-content"></div>
                        <button class="copy-btn" id="copy-plc-debug-btn">
                            Copy Raw Audit Log
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Create Account Tab -->
            <div class="tab-pane" id="createaccount-pane">
                <div class="plc-form-container">
                    <h2>üë§ Create New Account</h2>
                    <p class="plc-subtitle">Create a new ATProto account using your browser-controlled DID:PLC identity</p>
                    
                    <form id="createaccount-form" class="plc-form">
                        <div class="form-group">
                            <label for="pds-endpoint">PDS Endpoint</label>
                            <input type="url" id="pds-endpoint" name="pdsEndpoint" placeholder="https://your-pds.example.com" required>
                            <small class="form-help">The URL of your Personal Data Server</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="account-handle">Handle</label>
                            <input type="text" id="account-handle" name="handle" placeholder="username" required>
                            <small class="form-help">Your desired handle (username) for the account</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="account-email">Email</label>
                            <input type="email" id="account-email" name="email" placeholder="user@example.com" required>
                            <small class="form-help">Email address for account verification</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="account-password">Password</label>
                            <input type="password" id="account-password" name="password" placeholder="Secure password" required>
                            <small class="form-help">Password for account authentication</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="account-did">DID:PLC Identifier</label>
                            <input type="text" id="account-did" name="did" placeholder="did:plc:..." readonly>
                            <small class="form-help">Your browser-controlled DID:PLC identifier (auto-generated from DID:PLC Entry tab)</small>
                        </div>
                        
                        <div class="form-button-group">
                            <button type="submit" class="submit-btn" id="submit-createaccount-btn">
                                Create Account
                            </button>
                            <button type="button" class="clear-btn" id="clear-createaccount-btn">
                                Clear Form
                            </button>
                        </div>
                    </form>
                    
                    <div class="plc-result" id="createaccount-result" style="display: none;">
                        <h3>‚úÖ Account Created Successfully</h3>
                        <div class="plc-result-content" id="createaccount-result-content"></div>
                        <button class="copy-btn" id="copy-createaccount-result-btn">
                            Copy Account Details
                        </button>
                    </div>
                </div>
                
                <div class="status"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as secp256k1 from 'https://cdn.jsdelivr.net/npm/@noble/secp256k1@1.7.1/+esm';
        import { encode as dagCborEncode } from 'https://cdn.jsdelivr.net/npm/@ipld/dag-cbor@8.0.0/+esm';
        import { CID } from 'https://cdn.jsdelivr.net/npm/multiformats@12.1.3/+esm';
        import * as digest from 'https://cdn.jsdelivr.net/npm/multiformats@12.1.3/hashes/digest/+esm';
        import { base32 } from 'https://cdn.jsdelivr.net/npm/multiformats@12.1.3/bases/base32/+esm';
        
        // Base58 alphabet
        const BASE58_ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
        
        // Simple base58 encoder
        function base58Encode(bytes) {
            if (bytes.length === 0) return '';
            
            // Convert bytes to big integer
            let num = 0n;
            for (let i = 0; i < bytes.length; i++) {
                num = num * 256n + BigInt(bytes[i]);
            }
            
            // Convert to base58
            let result = '';
            while (num > 0n) {
                result = BASE58_ALPHABET[Number(num % 58n)] + result;
                num = num / 58n;
            }
            
            // Add leading '1's for leading zeros
            for (let i = 0; i < bytes.length && bytes[i] === 0; i++) {
                result = '1' + result;
            }
            
            return result;
        }
        
        let currentKey = null;
        let currentMnemonic = null;
        let currentPublicKey = null;
        let currentDidKey = null;
        
        // BIP39 English wordlist (first 2048 words)
        const BIP39_WORDLIST = [
            "abandon", "ability", "able", "about", "above", "absent", "absorb", "abstract", "absurd", "abuse",
            "access", "accident", "account", "accuse", "achieve", "acid", "acoustic", "acquire", "across", "act",
            "action", "actor", "actress", "actual", "adapt", "add", "addict", "address", "adjust", "admit",
            "adult", "advance", "advice", "aerobic", "affair", "afford", "afraid", "again", "age", "agent",
            "agree", "ahead", "aim", "air", "airport", "aisle", "alarm", "album", "alcohol", "alert",
            "alien", "all", "alley", "allow", "almost", "alone", "alpha", "already", "also", "alter",
            "always", "amateur", "amazing", "among", "amount", "amused", "analyst", "anchor", "ancient", "anger",
            "angle", "angry", "animal", "ankle", "announce", "annual", "another", "answer", "antenna", "antique",
            "anxiety", "any", "apart", "apology", "appear", "apple", "approve", "april", "arch", "arctic",
            "area", "arena", "argue", "arm", "armed", "armor", "army", "around", "arrange", "arrest",
            "arrive", "arrow", "art", "artefact", "artist", "artwork", "ask", "aspect", "assault", "asset",
            "assist", "assume", "asthma", "athlete", "atom", "attack", "attend", "attitude", "attract", "auction",
            "audit", "august", "aunt", "author", "auto", "autumn", "average", "avocado", "avoid", "awake",
            "aware", "away", "awesome", "awful", "awkward", "axis", "baby", "bachelor", "bacon", "badge",
            "bag", "balance", "balcony", "ball", "bamboo", "banana", "banner", "bar", "barely", "bargain",
            "barrel", "base", "basic", "basket", "battle", "beach", "bean", "beauty", "because", "become",
            "beef", "before", "begin", "behave", "behind", "believe", "below", "belt", "bench", "benefit",
            "best", "betray", "better", "between", "beyond", "bicycle", "bid", "bike", "bind", "biology",
            "bird", "birth", "bitter", "black", "blade", "blame", "blanket", "blast", "bleak", "bless",
            "blind", "blood", "blossom", "blow", "blue", "blur", "blush", "board", "boat", "body",
            "boil", "bomb", "bone", "bonus", "book", "boost", "border", "boring", "borrow", "boss",
            "bottom", "bounce", "box", "boy", "bracket", "brain", "brand", "brass", "brave", "bread",
            "breeze", "brick", "bridge", "brief", "bright", "bring", "brisk", "broccoli", "broken", "bronze",
            "broom", "brother", "brown", "brush", "bubble", "buddy", "budget", "buffalo", "build", "bulb",
            "bulk", "bullet", "bundle", "bunker", "burden", "burger", "burst", "bus", "business", "busy",
            "butter", "buyer", "buzz", "cabbage", "cabin", "cable", "cactus", "cage", "cake", "call",
            "calm", "camera", "camp", "can", "canal", "cancel", "candy", "cannon", "canoe", "canvas",
            "canyon", "capable", "capital", "captain", "car", "carbon", "card", "cargo", "carpet", "carry",
            "cart", "case", "cash", "casino", "cast", "casual", "cat", "catalog", "catch", "category",
            "cattle", "caught", "cause", "caution", "cave", "ceiling", "celery", "cement", "census", "century",
            "cereal", "certain", "chair", "chalk", "champion", "change", "chaos", "chapter", "charge", "chase",
            "cheap", "check", "cheese", "chef", "cherry", "chest", "chicken", "chief", "child", "chimney",
            "choice", "choose", "chronic", "chuckle", "chunk", "churn", "cigar", "cinnamon", "circle", "citizen",
            "city", "civil", "claim", "clamp", "clarify", "claw", "clay", "clean", "clerk", "clever",
            "click", "client", "cliff", "climb", "clinic", "clip", "clock", "clog", "close", "cloth",
            "cloud", "clown", "club", "clump", "cluster", "clutch", "coach", "coast", "coconut", "code",
            "coffee", "coil", "coin", "collect", "color", "column", "come", "comfort", "comic", "common",
            "company", "concert", "conduct", "confirm", "congress", "connect", "consider", "control", "convince", "cook",
            "cool", "copper", "copy", "coral", "core", "corn", "correct", "cost", "cotton", "couch",
            "country", "couple", "course", "cousin", "cover", "coyote", "crack", "cradle", "craft", "cram",
            "crane", "crash", "crater", "crawl", "crazy", "cream", "credit", "creek", "crew", "cricket",
            "crime", "crisp", "critic", "crop", "cross", "crouch", "crowd", "crucial", "cruel", "cruise",
            "crumble", "crunch", "crush", "cry", "crystal", "cube", "culture", "cup", "cupboard", "curious",
            "current", "curtain", "curve", "cushion", "custom", "cute", "cycle", "dad", "damage", "damp",
            "dance", "danger", "daring", "dash", "daughter", "dawn", "day", "deal", "debate", "debris",
            "decade", "december", "decide", "decline", "decorate", "decrease", "deer", "defense", "define", "defy",
            "degree", "delay", "deliver", "demand", "demise", "denial", "dentist", "deny", "depart", "depend",
            "deposit", "depth", "deputy", "derive", "describe", "desert", "design", "desk", "despair", "destroy",
            "detail", "detect", "develop", "device", "devote", "diagram", "dial", "diamond", "diary", "dice",
            "diesel", "diet", "differ", "digital", "dignity", "dilemma", "dinner", "dinosaur", "direct", "dirt",
            "disagree", "discover", "disease", "dish", "dismiss", "disorder", "display", "distance", "divert", "divide",
            "divorce", "dizzy", "doctor", "document", "dog", "doll", "dolphin", "domain", "donate", "donkey",
            "donor", "door", "dose", "double", "dove", "draft", "dragon", "drama", "drastic", "draw",
            "dream", "dress", "drift", "drill", "drink", "drip", "drive", "drop", "drum", "dry",
            "duck", "dumb", "dune", "during", "dust", "dutch", "duty", "dwarf", "dynamic", "eager",
            "eagle", "early", "earn", "earth", "easily", "east", "easy", "echo", "ecology", "economy",
            "edge", "edit", "educate", "effort", "egg", "eight", "either", "elbow", "elder", "electric",
            "elegant", "element", "elephant", "elevator", "elite", "else", "embark", "embody", "embrace", "emerge",
            "emotion", "employ", "empower", "empty", "enable", "enact", "end", "endless", "endorse", "enemy",
            "energy", "enforce", "engage", "engine", "english", "enjoy", "enlist", "enough", "enrich", "enroll",
            "ensure", "enter", "entire", "entry", "envelope", "episode", "equal", "equip", "era", "erase",
            "erode", "erosion", "erupt", "escape", "essay", "essence", "estate", "eternal", "ethics", "evidence",
            "evil", "evoke", "evolve", "exact", "example", "excess", "exchange", "excite", "exclude", "excuse",
            "execute", "exercise", "exhaust", "exhibit", "exile", "exist", "exit", "exotic", "expand", "expect",
            "expire", "explain", "expose", "express", "extend", "extra", "eye", "eyebrow", "fabric", "face",
            "faculty", "fade", "faint", "faith", "fall", "false", "fame", "family", "famous", "fan",
            "fancy", "fantasy", "farm", "fashion", "fat", "fatal", "father", "fatigue", "fault", "favorite",
            "feature", "february", "federal", "fee", "feed", "feel", "female", "fence", "festival", "fetch",
            "fever", "few", "fiber", "fiction", "field", "figure", "file", "film", "filter", "final",
            "find", "fine", "finger", "finish", "fire", "firm", "first", "fiscal", "fish", "fitness",
            "fix", "flag", "flame", "flash", "flat", "flavor", "flee", "flight", "flip", "float",
            "flock", "floor", "flower", "fluid", "flush", "fly", "foam", "focus", "fog", "foil",
            "fold", "follow", "food", "foot", "force", "forest", "forget", "fork", "fortune", "forum",
            "forward", "fossil", "foster", "found", "fox", "fragile", "frame", "frequent", "fresh", "friend",
            "fringe", "frog", "front", "frost", "frown", "frozen", "fruit", "fuel", "fun", "funny",
            "furnace", "fury", "future", "gadget", "gain", "galaxy", "gallery", "game", "gap", "garage",
            "garbage", "garden", "garlic", "garment", "gas", "gasp", "gate", "gather", "gauge", "gaze",
            "general", "genius", "genre", "gentle", "genuine", "gesture", "ghost", "giant", "gift", "giggle",
            "ginger", "giraffe", "girl", "give", "glad", "glance", "glare", "glass", "glide", "glimpse",
            "globe", "gloom", "glory", "glove", "glow", "glue", "goat", "goddess", "gold", "good",
            "goose", "gorilla", "gospel", "gossip", "govern", "gown", "grab", "grace", "grain", "grant",
            "grape", "grass", "gravity", "great", "green", "grid", "grief", "grit", "grocery", "group",
            "grow", "grunt", "guard", "guess", "guide", "guilt", "guitar", "gun", "gym", "habit",
            "hair", "half", "hammer", "hamster", "hand", "happy", "harbor", "hard", "harsh", "harvest",
            "hash", "hat", "have", "hawk", "hazard", "head", "health", "heart", "heavy", "hedgehog",
            "height", "hello", "helmet", "help", "hen", "hero", "hidden", "high", "hill", "hint",
            "hip", "hire", "history", "hobby", "hockey", "hold", "hole", "holiday", "hollow", "home",
            "honey", "hood", "hope", "horn", "horror", "horse", "hospital", "host", "hotel", "hour",
            "hover", "hub", "huge", "human", "humble", "humor", "hundred", "hungry", "hunt", "hurdle",
            "hurry", "hurt", "husband", "hybrid", "ice", "icon", "idea", "identify", "idle", "ignore",
            "ill", "illegal", "illness", "image", "imitate", "immense", "immune", "impact", "impose", "improve",
            "impulse", "inch", "include", "income", "increase", "index", "indicate", "indoor", "industry", "infant",
            "inflict", "inform", "inhale", "inherit", "initial", "inject", "injury", "inmate", "inner", "innocent",
            "input", "inquiry", "insane", "insect", "inside", "inspire", "install", "intact", "interest", "into",
            "invest", "invite", "involve", "iron", "island", "isolate", "issue", "item", "ivory", "jacket",
            "jaguar", "jar", "jazz", "jealous", "jeans", "jelly", "jewel", "job", "join", "joke",
            "journey", "joy", "judge", "juice", "jump", "jungle", "junior", "junk", "just", "kangaroo",
            "keen", "keep", "ketchup", "key", "kick", "kid", "kidney", "kind", "kingdom", "kiss",
            "kit", "kitchen", "kite", "kitten", "kiwi", "knee", "knife", "knock", "know", "lab",
            "label", "labor", "ladder", "lady", "lake", "lamp", "land", "large", "last", "latin",
            "laugh", "laundry", "lava", "law", "lawn", "lawsuit", "layer", "lazy", "leader", "leaf",
            "learn", "leave", "lecture", "left", "leg", "legal", "legend", "leisure", "lemon", "lend",
            "length", "lens", "leopard", "lesson", "letter", "level", "liar", "liberty", "library", "license",
            "life", "lift", "light", "like", "limb", "limit", "link", "lion", "liquid", "list",
            "little", "live", "lizard", "load", "loan", "lobster", "local", "lock", "logic", "lonely",
            "long", "loop", "lottery", "loud", "lounge", "love", "loyal", "lucky", "luggage", "lumber",
            "lunar", "lunch", "lung", "luxury", "lyrics", "machine", "mad", "magic", "magnet", "maid",
            "mail", "main", "major", "make", "mammal", "man", "manage", "mandate", "mango", "mansion",
            "manual", "maple", "marble", "march", "margin", "marine", "market", "marriage", "mask", "mass",
            "master", "match", "material", "math", "matrix", "matter", "maximum", "maze", "meadow", "mean",
            "measure", "meat", "mechanic", "medal", "media", "melody", "melt", "member", "memory", "mention",
            "menu", "mercy", "merge", "merit", "merry", "mesh", "message", "metal", "method", "middle",
            "midnight", "milk", "million", "mimic", "mind", "minimum", "minor", "minute", "miracle", "mirror",
            "misery", "miss", "mistake", "mix", "mixed", "mixture", "mobile", "model", "modify", "mom",
            "moment", "monitor", "monkey", "monster", "month", "moon", "moral", "more", "morning", "mosquito",
            "mother", "motion", "motor", "mountain", "mouse", "move", "movie", "much", "muffin", "mule",
            "multiply", "muscle", "museum", "mushroom", "music", "must", "mutual", "myself", "mystery", "myth",
            "naive", "name", "napkin", "narrow", "nasty", "nation", "nature", "near", "neck", "need",
            "negative", "neglect", "neither", "nephew", "nerve", "nest", "net", "network", "neutral", "never",
            "news", "next", "nice", "night", "noble", "noise", "nominee", "noodle", "normal", "north",
            "nose", "notable", "note", "nothing", "notice", "novel", "now", "nuclear", "number", "nurse",
            "nut", "oak", "obey", "object", "oblige", "obscure", "observe", "obtain", "obvious", "occur",
            "ocean", "october", "odor", "off", "offer", "office", "often", "oil", "okay", "old",
            "olive", "olympic", "omit", "once", "one", "onion", "online", "only", "open", "opera",
            "opinion", "oppose", "option", "orange", "orbit", "orchard", "order", "ordinary", "organ", "orient",
            "original", "orphan", "ostrich", "other", "outdoor", "outer", "output", "outside", "oval", "oven",
            "over", "own", "owner", "oxygen", "oyster", "ozone", "pact", "paddle", "page", "pair",
            "palace", "palm", "panda", "panel", "panic", "panther", "paper", "parade", "parent", "park",
            "parrot", "party", "pass", "patch", "path", "patient", "patrol", "pattern", "pause", "pave",
            "payment", "peace", "peanut", "pear", "peasant", "pelican", "pen", "penalty", "pencil", "people",
            "pepper", "perfect", "permit", "person", "pet", "phone", "photo", "phrase", "physical", "piano",
            "picnic", "picture", "piece", "pig", "pigeon", "pill", "pilot", "pink", "pioneer", "pipe",
            "pistol", "pitch", "pizza", "place", "planet", "plastic", "plate", "play", "please", "pledge",
            "pluck", "plug", "plunge", "poem", "poet", "point", "polar", "pole", "police", "pond",
            "pony", "pool", "poor", "pop", "popcorn", "popular", "portion", "position", "possible", "post",
            "pot", "potato", "pottery", "poverty", "powder", "power", "practice", "praise", "predict", "prefer",
            "prepare", "present", "pretty", "prevent", "price", "pride", "primary", "print", "priority", "prison",
            "private", "prize", "problem", "process", "produce", "profit", "program", "project", "promote", "proof",
            "property", "prosper", "protect", "proud", "provide", "public", "pudding", "pull", "pulp", "pulse",
            "pumpkin", "punch", "pupil", "puppy", "push", "put", "puzzle", "pyramid", "quality", "quantum",
            "quarter", "question", "quick", "quit", "quiz", "quote", "rabbit", "raccoon", "race", "rack",
            "radar", "radio", "rail", "rain", "raise", "rally", "ramp", "ranch", "random", "range",
            "rapid", "rare", "rate", "rather", "raven", "raw", "razor", "ready", "real", "reason",
            "rebel", "rebuild", "recall", "receive", "recipe", "record", "recover", "recycle", "reduce", "reflect",
            "reform", "refuse", "region", "regret", "regular", "reject", "relax", "release", "relief", "rely",
            "remain", "remember", "remind", "remove", "render", "renew", "rent", "reopen", "repair", "repeat",
            "replace", "reply", "report", "require", "rescue", "resemble", "resist", "resource", "response", "result",
            "retire", "retreat", "return", "reveal", "review", "reward", "rhythm", "rib", "ribbon", "rice",
            "rich", "ride", "ridge", "rifle", "right", "rigid", "ring", "riot", "ripple", "risk",
            "ritual", "rival", "river", "road", "roast", "robot", "robust", "rocket", "romance", "roof",
            "rookie", "room", "rooster", "root", "rope", "rose", "rotate", "rough", "round", "route",
            "row", "royal", "rubber", "rude", "rug", "rule", "rumor", "run", "runway", "rural",
            "sad", "saddle", "sadness", "safe", "sail", "salad", "salmon", "salon", "salt", "salute",
            "same", "sample", "sand", "satisfy", "satoshi", "sauce", "sausage", "save", "say", "scale",
            "scan", "scare", "scatter", "scene", "scheme", "school", "science", "scissors", "scorpion", "scout",
            "scrap", "screen", "script", "scrub", "sea", "search", "season", "seat", "second", "secret",
            "section", "security", "seed", "seek", "segment", "select", "sell", "seminar", "senior", "sense",
            "sentence", "series", "service", "session", "settle", "setup", "seven", "shadow", "shaft", "shallow",
            "share", "shed", "shell", "sheriff", "shield", "shift", "shine", "ship", "shiver", "shock",
            "shoe", "shoot", "shop", "shore", "short", "shoulder", "shove", "shrimp", "shrug", "shy",
            "sibling", "sick", "side", "siege", "sight", "sign", "silent", "silk", "silly", "silver",
            "similar", "simple", "since", "sing", "siren", "sister", "situate", "six", "size", "skate",
            "sketch", "ski", "skill", "skin", "skirt", "skull", "slab", "slam", "sleep", "slender",
            "slice", "slide", "slight", "slim", "slogan", "slot", "slow", "sluice", "slum", "slurp",
            "slush", "sly", "smack", "small", "smart", "smile", "smoke", "smooth", "smug", "snack",
            "snake", "snap", "snare", "snarl", "sneak", "sneeze", "sniff", "snore", "snort", "snout",
            "snow", "snub", "snuff", "snug", "soak", "soap", "soar", "sob", "soccer", "social",
            "sock", "soda", "soft", "soggy", "soil", "solar", "soldier", "solid", "solo", "solution",
            "solve", "someone", "song", "soon", "sorry", "sort", "soul", "sound", "soup", "sour",
            "south", "space", "spare", "spark", "spatial", "spawn", "speak", "speed", "spell", "spend",
            "sphere", "spice", "spider", "spike", "spin", "spirit", "split", "spoil", "sponsor", "spoon",
            "sport", "spot", "spouse", "spray", "spread", "spring", "spy", "square", "squeeze", "squirrel",
            "stable", "stadium", "staff", "stage", "stairs", "stamp", "stand", "start", "state", "stay",
            "steak", "steel", "steep", "stem", "step", "stereo", "stick", "still", "sting", "stink",
            "stir", "stock", "stomach", "stone", "stool", "stoop", "stop", "store", "storm", "story",
            "stove", "straddle", "straight", "strain", "strand", "strap", "straw", "stream", "street", "stress",
            "stretch", "strict", "stride", "strike", "string", "strive", "stroke", "stroll", "strong", "struck",
            "structure", "struggle", "stuck", "student", "stuff", "stumble", "stunned", "stunt", "style", "subdue",
            "subject", "submit", "subway", "success", "such", "sudden", "suffer", "sugar", "suggest", "suit",
            "sultan", "summer", "sun", "sunny", "sunset", "super", "supply", "supreme", "sure", "surface",
            "surge", "surprise", "surround", "survey", "suspect", "sustain", "swallow", "swamp", "swap", "swarm",
            "sway", "swear", "sweet", "swift", "swim", "swing", "switch", "sword", "swore", "sworn",
            "swung", "syllable", "symbol", "symptom", "syndicate", "synergy", "syrup", "system", "taboo", "tackle",
            "tag", "tail", "talent", "talk", "tank", "tape", "target", "task", "taste", "tattoo",
            "taxi", "teach", "team", "tell", "ten", "tenant", "tennis", "tent", "term", "test",
            "text", "thank", "that", "the", "their", "them", "then", "theory", "there", "they",
            "thing", "think", "third", "this", "those", "though", "thought", "three", "through", "throw",
            "thumb", "thunder", "thus", "tick", "tide", "tidy", "tie", "tiger", "tight", "tile",
            "till", "timber", "time", "tiny", "tip", "tired", "tissue", "title", "to", "toast",
            "today", "toddler", "toe", "together", "toilet", "token", "tomato", "tomorrow", "tone", "tongue",
            "tonight", "tool", "tooth", "top", "topic", "topple", "torch", "tornado", "tortoise", "toss",
            "total", "touch", "tough", "tour", "toward", "tower", "town", "toy", "track", "trade",
            "traffic", "tragic", "train", "transfer", "trap", "trash", "travel", "tray", "treat", "tree",
            "trend", "trial", "tribe", "trick", "trigger", "trim", "trip", "trophy", "trouble", "truck",
            "true", "truly", "trumpet", "trust", "truth", "try", "tube", "tuition", "tumble", "tuna",
            "tunnel", "turbo", "turtle", "twelve", "twenty", "twice", "twin", "twist", "two", "type",
            "typical", "ugly", "umbrella", "unable", "unaware", "uncle", "uncover", "under", "undo", "unfair",
            "unfold", "unhappy", "uniform", "unique", "unit", "universe", "unknown", "unlock", "until", "unusual",
            "unveil", "update", "upgrade", "uphold", "upon", "upper", "upset", "urban", "urge", "usage",
            "use", "used", "useful", "useless", "usual", "utility", "vacant", "vacuum", "vague", "valley",
            "valve", "van", "vanish", "vapor", "various", "vast", "vault", "vehicle", "velvet", "vendor",
            "venture", "venue", "verb", "verify", "version", "very", "vessel", "veteran", "viable", "vibrant",
            "vicious", "victory", "video", "view", "village", "vintage", "violin", "viral", "virtual", "virus",
            "visa", "visit", "visual", "vital", "vivid", "vocal", "voice", "void", "volcano", "volume",
            "vote", "voyage", "wage", "wagon", "wait", "wake", "walk", "wall", "walnut", "want",
            "war", "warm", "warrior", "wash", "wasp", "waste", "water", "wave", "way", "weak",
            "wealth", "weapon", "wear", "weasel", "weather", "web", "wedding", "weed", "week", "weird",
            "welcome", "west", "wet", "whale", "what", "wheat", "wheel", "when", "where", "whip",
            "whisper", "white", "who", "whole", "whom", "whose", "why", "wicked", "wide", "width",
            "wife", "wild", "will", "win", "wind", "window", "wine", "wing", "wink", "winner",
            "winter", "wire", "wisdom", "wise", "wish", "witness", "wolf", "woman", "wonder", "wood",
            "wool", "word", "work", "world", "worry", "worth", "would", "wound", "wrap", "wreck",
            "wrestle", "wrist", "write", "wrong", "yard", "year", "yellow", "you", "young", "youth",
            "zebra", "zero", "zone", "zoo"
        ];
        
        // Simple BIP39 implementation
        function generateMnemonic(entropyHex) {
            // Convert hex to binary
            let binary = '';
            for (let i = 0; i < entropyHex.length; i += 2) {
                const hexByte = entropyHex.substr(i, 2);
                const binaryByte = parseInt(hexByte, 16).toString(2).padStart(8, '0');
                binary += binaryByte;
            }
            
            // Calculate checksum (first 8 bits of SHA256 hash)
            const hash = crypto.subtle ? null : 'fallback'; // We'll use a simple checksum for now
            const checksumBits = 8; // For 256-bit entropy, we need 8 bits of checksum
            const totalBits = 256 + checksumBits; // 264 bits total
            
            // Add simple checksum (XOR of all bytes)
            let checksum = 0;
            for (let i = 0; i < entropyHex.length; i += 2) {
                checksum ^= parseInt(entropyHex.substr(i, 2), 16);
            }
            const checksumBinary = checksum.toString(2).padStart(8, '0');
            
            // Combine entropy + checksum
            const fullBinary = binary + checksumBinary;
            
            // Convert to mnemonic words (11 bits per word)
            const words = [];
            for (let i = 0; i < fullBinary.length; i += 11) {
                const wordIndex = parseInt(fullBinary.substr(i, 11), 2);
                words.push(BIP39_WORDLIST[wordIndex]);
            }
            
            return words.join(' ');
        }

        // Convert mnemonic back to entropy
        function mnemonicToEntropy(mnemonic) {
            const words = mnemonic.trim().split(/\s+/);
            
            // Validate word count
            if (words.length !== 24) {
                throw new Error('Mnemonic must contain exactly 24 words');
            }
            
            // Convert words to binary
            let binary = '';
            for (const word of words) {
                const index = BIP39_WORDLIST.indexOf(word.toLowerCase());
                if (index === -1) {
                    throw new Error(`Invalid word: "${word}"`);
                }
                binary += index.toString(2).padStart(11, '0');
            }
            
            // Split into entropy and checksum
            const entropyBinary = binary.substring(0, 256);
            const checksumBinary = binary.substring(256);
            
            // Convert entropy binary to hex
            let entropyHex = '';
            for (let i = 0; i < entropyBinary.length; i += 8) {
                const byte = entropyBinary.substr(i, 8);
                entropyHex += parseInt(byte, 2).toString(16).padStart(2, '0');
            }
            
            // Verify checksum
            let calculatedChecksum = 0;
            for (let i = 0; i < entropyHex.length; i += 2) {
                calculatedChecksum ^= parseInt(entropyHex.substr(i, 2), 16);
            }
            const expectedChecksum = parseInt(checksumBinary, 2);
            
            if (calculatedChecksum !== expectedChecksum) {
                throw new Error('Invalid mnemonic: checksum verification failed');
            }
            
            return entropyHex;
        }

        // Validate mnemonic phrase
        function validateMnemonic(mnemonic) {
            try {
                const words = mnemonic.trim().split(/\s+/);
                
                if (words.length !== 24) {
                    return { valid: false, error: 'Mnemonic must contain exactly 24 words' };
                }
                
                for (const word of words) {
                    if (BIP39_WORDLIST.indexOf(word.toLowerCase()) === -1) {
                        return { valid: false, error: `Invalid word: "${word}"` };
                    }
                }
                
                // Try to convert to entropy to verify checksum
                mnemonicToEntropy(mnemonic);
                
                return { valid: true };
            } catch (error) {
                return { valid: false, error: error.message };
            }
        }

        // Generate secp256k1 public key from private key
        function generatePublicKey(privateKeyHex) {
            try {
                // Convert hex string to Uint8Array
                const privateKeyBytes = new Uint8Array(32);
                for (let i = 0; i < privateKeyHex.length; i += 2) {
                    privateKeyBytes[i / 2] = parseInt(privateKeyHex.substr(i, 2), 16);
                }
                
                // Generate public key using @noble/secp256k1
                const publicKeyBytes = secp256k1.getPublicKey(privateKeyBytes, true); // true = compressed
                
                // Convert public key bytes to hex string
                const publicKeyHex = Array.from(publicKeyBytes)
                    .map(byte => byte.toString(16).padStart(2, '0'))
                    .join('');
                
                return publicKeyHex;
            } catch (error) {
                console.error('Error generating public key:', error);
                throw new Error('Failed to generate public key: ' + error.message);
            }
        }

        // Generate DID key from secp256k1 public key
        function generateDidKey(publicKeyHex) {
            try {
                // Convert hex string to Uint8Array
                const publicKeyBytes = new Uint8Array(33);
                for (let i = 0; i < publicKeyHex.length; i += 2) {
                    publicKeyBytes[i / 2] = parseInt(publicKeyHex.substr(i, 2), 16);
                }
                
                // Add multicodec prefix for secp256k1 compressed public key (0xe7)
                const multicodecPrefix = new Uint8Array([0xe7, 0x01]);
                const prefixedKey = new Uint8Array([...multicodecPrefix, ...publicKeyBytes]);
                
                // Encode using base58
                const encoded = base58Encode(prefixedKey);
                
                // Construct DID key with 'z' prefix for base58btc
                const didKey = `did:key:z${encoded}`;
                
                return didKey;
            } catch (error) {
                console.error('Error generating DID key:', error);
                throw new Error('Failed to generate DID key: ' + error.message);
            }
        }

        async function generateKey() {
            const keyDisplay = document.getElementById('keyDisplay');
            const mnemonicDisplay = document.getElementById('mnemonicDisplay');
            const mnemonicText = document.getElementById('mnemonicText');
            const publicKeyDisplay = document.getElementById('publicKeyDisplay');
            const publicKeyText = document.getElementById('publicKeyText');
            const didKeyDisplay = document.getElementById('didKeyDisplay');
            const didKeyText = document.getElementById('didKeyText');
            const copyBtn = document.getElementById('copyBtn');
            const copyMnemonicBtn = document.getElementById('copyMnemonicBtn');
            const copyPublicKeyBtn = document.getElementById('copyPublicKeyBtn');
            const copyDidKeyBtn = document.getElementById('copyDidKeyBtn');
            const generateBtn = document.getElementById('generateBtn');
            const status = getCurrentStatusElement();

            try {
                // Show loading state
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generating...';
                keyDisplay.textContent = 'Generating secure random key, mnemonic, and public key...';
                mnemonicDisplay.style.display = 'none';
                publicKeyDisplay.style.display = 'none';
                status.innerHTML = '';

                // Generate 256 bits (32 bytes) of random data
                const randomBytes = new Uint8Array(32);
                crypto.getRandomValues(randomBytes);

                // Convert to hexadecimal string
                currentKey = Array.from(randomBytes)
                    .map(byte => byte.toString(16).padStart(2, '0'))
                    .join('');

                // Generate BIP39 mnemonic from the entropy
                currentMnemonic = generateMnemonic(currentKey);

                // Generate secp256k1 public key
                currentPublicKey = generatePublicKey(currentKey);

                // Generate DID key
                currentDidKey = generateDidKey(currentPublicKey);

                // Display the key
                keyDisplay.textContent = currentKey;
                keyDisplay.classList.add('has-key');
                
                // Display the mnemonic
                mnemonicText.textContent = currentMnemonic;
                mnemonicDisplay.style.display = 'block';
                
                // Display the public key
                publicKeyText.textContent = currentPublicKey;
                publicKeyDisplay.style.display = 'block';
                
                // Display the DID key
                didKeyText.textContent = currentDidKey;
                didKeyDisplay.style.display = 'block';
                
                // Enable copy buttons
                copyBtn.disabled = false;
                copyMnemonicBtn.disabled = false;
                copyPublicKeyBtn.disabled = false;
                copyDidKeyBtn.disabled = false;

                if (status) {
                    status.innerHTML = '<div class="status success">‚úÖ Key, mnemonic, public key, and DID key generated successfully!</div>';
                }

            } catch (error) {
                console.error('Error generating key:', error);
                if (status) {
                    status.innerHTML = '<div class="status error">‚ùå Error generating key. Please try again.</div>';
                }
                keyDisplay.textContent = 'Error generating key. Please try again.';
                keyDisplay.classList.remove('has-key');
                mnemonicDisplay.style.display = 'none';
                publicKeyDisplay.style.display = 'none';
                didKeyDisplay.style.display = 'none';
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate New Key';
            }
        }

        async function copyKey() {
            if (!currentKey) return;

            try {
                await navigator.clipboard.writeText(currentKey);
                const status = getCurrentStatusElement();
                if (status) {
                    status.innerHTML = '<div class="status success">üìã Key copied to clipboard!</div>';
                }
                
                // Clear status after 3 seconds
                setTimeout(() => {
                    if (status) {
                        status.innerHTML = '';
                    }
                }, 3000);
            } catch (error) {
                console.error('Error copying to clipboard:', error);
                const status = getCurrentStatusElement();
                if (status) {
                    status.innerHTML = '<div class="status error">‚ùå Failed to copy to clipboard</div>';
                }
            }
        }

        async function copyMnemonic() {
            if (!currentMnemonic) return;

            try {
                await navigator.clipboard.writeText(currentMnemonic);
                const status = getCurrentStatusElement();
                if (status) {
                    status.innerHTML = '<div class="status success">üìã Mnemonic copied to clipboard!</div>';
                }
                
                // Clear status after 3 seconds
                setTimeout(() => {
                    if (status) {
                        status.innerHTML = '';
                    }
                }, 3000);
            } catch (error) {
                console.error('Error copying mnemonic to clipboard:', error);
                const status = getCurrentStatusElement();
                if (status) {
                    status.innerHTML = '<div class="status error">‚ùå Failed to copy mnemonic to clipboard</div>';
                }
            }
        }

        async function copyPublicKey() {
            if (!currentPublicKey) return;

            try {
                await navigator.clipboard.writeText(currentPublicKey);
                const status = getCurrentStatusElement();
                if (status) {
                    status.innerHTML = '<div class="status success">üìã Public key copied to clipboard!</div>';
                }
                
                // Clear status after 3 seconds
                setTimeout(() => {
                    if (status) {
                        status.innerHTML = '';
                    }
                }, 3000);
            } catch (error) {
                console.error('Error copying public key to clipboard:', error);
                const status = getCurrentStatusElement();
                if (status) {
                    status.innerHTML = '<div class="status error">‚ùå Failed to copy public key to clipboard</div>';
                }
            }
        }

        async function copyDidKey() {
            if (!currentDidKey) return;

            try {
                await navigator.clipboard.writeText(currentDidKey);
                const status = getCurrentStatusElement();
                if (status) {
                    status.innerHTML = '<div class="status success">üìã DID key copied to clipboard!</div>';
                }
                
                // Clear status after 3 seconds
                setTimeout(() => {
                    if (status) {
                        status.innerHTML = '';
                    }
                }, 3000);
            } catch (error) {
                console.error('Error copying DID key to clipboard:', error);
                const status = getCurrentStatusElement();
                if (status) {
                    status.innerHTML = '<div class="status error">‚ùå Failed to copy DID key to clipboard</div>';
                }
            }
        }

        async function restoreFromMnemonic() {
            const mnemonicInput = document.getElementById('mnemonicInput');
            const keyDisplay = document.getElementById('keyDisplay');
            const mnemonicDisplay = document.getElementById('mnemonicDisplay');
            const mnemonicText = document.getElementById('mnemonicText');
            const publicKeyDisplay = document.getElementById('publicKeyDisplay');
            const publicKeyText = document.getElementById('publicKeyText');
            const didKeyDisplay = document.getElementById('didKeyDisplay');
            const didKeyText = document.getElementById('didKeyText');
            const copyBtn = document.getElementById('copyBtn');
            const copyMnemonicBtn = document.getElementById('copyMnemonicBtn');
            const copyPublicKeyBtn = document.getElementById('copyPublicKeyBtn');
            const copyDidKeyBtn = document.getElementById('copyDidKeyBtn');
            const restoreBtn = document.getElementById('restoreBtn');
            const status = getCurrentStatusElement();

            const inputMnemonic = mnemonicInput.value.trim();

            if (!inputMnemonic) {
                if (status) {
                    status.innerHTML = '<div class="status error">‚ùå Please enter a mnemonic phrase</div>';
                }
                return;
            }

            try {
                // Show loading state
                restoreBtn.disabled = true;
                restoreBtn.textContent = 'Restoring...';
                status.innerHTML = '';

                // Validate mnemonic
                const validation = validateMnemonic(inputMnemonic);
                if (!validation.valid) {
                    throw new Error(validation.error);
                }

                // Convert mnemonic to entropy
                const restoredKey = mnemonicToEntropy(inputMnemonic);

                // Generate secp256k1 public key
                const restoredPublicKey = generatePublicKey(restoredKey);

                // Generate DID key
                const restoredDidKey = generateDidKey(restoredPublicKey);

                // Update global variables
                currentKey = restoredKey;
                currentMnemonic = inputMnemonic;
                currentPublicKey = restoredPublicKey;
                currentDidKey = restoredDidKey;

                // Display the restored key
                keyDisplay.textContent = currentKey;
                keyDisplay.classList.add('has-key');

                // Display the mnemonic
                mnemonicText.textContent = currentMnemonic;
                mnemonicDisplay.style.display = 'block';

                // Display the public key
                publicKeyText.textContent = currentPublicKey;
                publicKeyDisplay.style.display = 'block';

                // Display the DID key
                didKeyText.textContent = currentDidKey;
                didKeyDisplay.style.display = 'block';

                // Enable copy buttons
                copyBtn.disabled = false;
                copyMnemonicBtn.disabled = false;
                copyPublicKeyBtn.disabled = false;
                copyDidKeyBtn.disabled = false;

                status.innerHTML = '<div class="status success">‚úÖ Private key, mnemonic, public key, and DID key restored successfully!</div>';

            } catch (error) {
                console.error('Error restoring from mnemonic:', error);
                status.innerHTML = `<div class="status error">‚ùå ${error.message}</div>`;
                keyDisplay.textContent = 'Error restoring key. Please check your mnemonic phrase.';
                keyDisplay.classList.remove('has-key');
                mnemonicDisplay.style.display = 'none';
                publicKeyDisplay.style.display = 'none';
                didKeyDisplay.style.display = 'none';
            } finally {
                restoreBtn.disabled = false;
                restoreBtn.textContent = 'Restore Private Key';
            }
        }

        function clearInput() {
            const mnemonicInput = document.getElementById('mnemonicInput');
            const status = getCurrentStatusElement();
            
            mnemonicInput.value = '';
            status.innerHTML = '';
        }

        // Helper function to get the status element for the current active tab
        function getCurrentStatusElement() {
            const activeTab = document.querySelector('.tab-pane.active');
            if (activeTab) {
                const statusElement = activeTab.querySelector('.status');
                if (statusElement) {
                    return statusElement;
                }
            }
            // Fallback: try to find any status element if active tab detection fails
            const fallbackStatus = document.querySelector('.status');
            if (fallbackStatus) {
                return fallbackStatus;
            }
            console.warn('No status element found');
            return null;
        }

        // Fetch actual operation from plc.directory
        async function fetchActualOperation() {
            try {
                const response = await fetch('https://plc.directory/did:plc:pyzlzqt6b2nyrha7smfry6rv/log/audit');
                const data = await response.json();
                const operation = data[0].operation;
                
                // Remove sig field for CID generation
                const operationForCid = { ...operation };
                delete operationForCid.sig;
                
                console.log('Fetched operation from plc.directory:', operationForCid);
                
                // Debug: Compare with expected structure
                console.log('=== Operation Structure Comparison ===');
                console.log('Operation keys:', Object.keys(operationForCid));
                console.log('Operation prev:', operationForCid.prev);
                console.log('Operation type:', operationForCid.type);
                console.log('Operation services:', operationForCid.services);
                console.log('Operation alsoKnownAs:', operationForCid.alsoKnownAs);
                console.log('Operation rotationKeys:', operationForCid.rotationKeys);
                console.log('Operation verificationMethods:', operationForCid.verificationMethods);
                
                return operationForCid;
            } catch (error) {
                console.error('Error fetching operation:', error);
                // Fallback to hardcoded operation
                return {
                    "prev": null,
                    "type": "plc_operation",
                    "services": {
                        "atproto_pds": {
                            "type": "AtprotoPersonalDataServer",
                            "endpoint": "https://bsky.social"
                        }
                    },
                    "alsoKnownAs": [
                        "at://edmundedgar.bsky.social"
                    ],
                    "rotationKeys": [
                        "did:key:zQ3shhCGUqDKjStzuDxPkTxN6ujddP4RkEKJJouJGRRkaLGbg",
                        "did:key:zQ3shpKnbdPx3g3CmPf5cRVTPe1HtSwVn5ish3wSnDPQCbLJK"
                    ],
                    "verificationMethods": {
                        "atproto": "did:key:zQ3shXjHeiBuRCKmM36cuYnm7YEMzhGnCmCyW92sRJ9pribSF"
                    }
                };
            }
        }

        // Test case for DID:PLC ID generation
        async function testDidPlcIdGeneration() {
            console.log('=== DID:PLC ID Generation Test ===');
            
            // Fetch the actual operation with signature from plc.directory
            const testDid = 'did:plc:pyzlzqt6b2nyrha7smfry6rv';
            const expectedCid = 'bafyreid6gk6me7qotoejyh4tbmohuniu37anfgb6lhr2po3btqannss3dq';
            
            try {
                const { didDocument, auditLog } = await fetchDidPlcRecord(testDid);
                const testOperation = auditLog[0].operation; // This includes the signature
                
                console.log('Fetched operation from plc.directory:', testOperation);
                console.log('Operation includes signature:', !!testOperation.sig);
                console.log('Signature value:', testOperation.sig);
                
                console.log('Expected DID:', testDid);
                console.log('Expected CID:', expectedCid);
                
                // Test the DID:PLC ID generation with signed operation
                const generatedDid = await generateDidPlcId(testOperation);
                console.log('Generated DID:', generatedDid);
                console.log('Match:', generatedDid === testDid ? '‚úÖ PASS' : '‚ùå FAIL');
                
                if (generatedDid !== testDid) {
                    console.log('‚ùå Test failed - generated DID does not match expected');
                    console.log('This may be due to:');
                    console.log('1. Different DAG-CBOR serialization order');
                    console.log('2. Different CID generation method');
                    console.log('3. Different base32 encoding');
                    console.log('4. Missing or incorrect signature');
                } else {
                    console.log('‚úÖ Test passed - DID:PLC ID generation is working correctly!');
                }
                
                return {
                    success: generatedDid === testDid,
                    operation: testOperation,
                    generatedDid: generatedDid,
                    expectedDid: testDid,
                    expectedCid: expectedCid
                };
            } catch (error) {
                console.error('‚ùå Test failed with error:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // SHA-256 hash function using Web Crypto API
        async function sha256Hash(data) {
            console.log('=== SHA-256 Hash Debug ===');
            console.log('Input data type:', typeof data);
            console.log('Input data constructor:', data.constructor.name);
            console.log('Input data length:', data.length);
            console.log('Input data (first 20 bytes hex):', Array.from(data.slice(0, 20)).map(b => b.toString(16).padStart(2, '0')).join(''));
            console.log('Input data (last 20 bytes hex):', Array.from(data.slice(-20)).map(b => b.toString(16).padStart(2, '0')).join(''));
            
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const result = new Uint8Array(hashBuffer);
            
            console.log('Hash result length:', result.length);
            console.log('Hash result (hex):', Array.from(result).map(b => b.toString(16).padStart(2, '0')).join(''));
            
            return result;
        }

        // Generate a DID:PLC ID from operation
        async function generateDidPlcId(operation) {
            try {
                // For testing with real data, include the signature
                // In production, you'd sign the unsigned operation first
                const operationForHash = { ...operation };
                
                console.log('Operation includes signature:', !!operationForHash.sig);
                console.log('Operation for hashing:', operationForHash);
                
                // Serialize operation to DAG-CBOR
                const dagCborBytes = dagCborEncode(operationForHash);
                
                // Debug: Output the DAG-CBOR bytes
                console.log('DAG-CBOR bytes length:', dagCborBytes.length);
                console.log('DAG-CBOR bytes (hex):', Array.from(dagCborBytes).map(b => b.toString(16).padStart(2, '0')).join(''));
                
                // Hash the DAG-CBOR bytes with SHA-256
                const hashBytes = await sha256Hash(dagCborBytes);
                
                console.log('SHA-256 hash (hex):', Array.from(hashBytes).map(b => b.toString(16).padStart(2, '0')).join(''));
                
                // Convert hash to base32 and take first 24 characters
                const hashBase32 = base32.encode(hashBytes);
                console.log('Hash base32:', hashBase32);
                
                // Remove 'b' prefix and padding, then take first 24 characters
                const base32Part = hashBase32.substring(1).replace(/=/g, '');
                console.log('Base32 part (no prefix/padding):', base32Part);
                console.log('Base32 part length:', base32Part.length);
                
                const didPlcId = base32Part.substring(0, 24);
                console.log('Extracted DID:PLC ID (first 24 chars):', didPlcId);
                console.log('Expected DID:PLC ID: pyzlzqt6b2nyrha7smfry6rv');
                
                return `did:plc:${didPlcId}`;
                
                // Debug: Check multihash digest structure
                console.log('Multihash digest object:', multihashDigest);
                console.log('Multihash digest has code property:', 'code' in multihashDigest);
                console.log('Multihash digest has size property:', 'size' in multihashDigest);
                console.log('Multihash digest has bytes property:', 'bytes' in multihashDigest);
                console.log('Multihash digest has digest property:', 'digest' in multihashDigest);
                
                // Debug: Output multihash digest details
                console.log('Multihash digest code:', multihashDigest.code);
                console.log('Multihash digest size:', multihashDigest.size);
                console.log('Multihash digest bytes (hex):', Array.from(multihashDigest.bytes).map(b => b.toString(16).padStart(2, '0')).join(''));
                console.log('Multihash digest bytes length:', multihashDigest.bytes.length);
                
                // Create CID from the digest
                console.log('Creating CID with:');
                console.log('- Version: 1');
                console.log('- Codec: 0x71 (113)');
                console.log('- Multihash digest:', multihashDigest);
                console.log('- Multihash digest code:', multihashDigest.code);
                console.log('- Multihash digest size:', multihashDigest.size);
                console.log('- Multihash digest bytes length:', multihashDigest.bytes.length);
                
                cid = CID.create(1, 0x71, multihashDigest); // CIDv1 with DAG-CBOR codec (0x71)
                
                // Debug: Decode the generated CID to see its raw bytes (including header)
                const generatedCidBase32 = cid.toString(base32);
                console.log('Generated CID base32 string:', generatedCidBase32);
                
                // Use the CID's bytes property directly if available
                if (cid.bytes) {
                    const generatedCidHex = Array.from(cid.bytes).map(b => b.toString(16).padStart(2, '0')).join('');
                    console.log('Generated CID raw bytes (hex):', generatedCidHex);
                    console.log('Generated CID length:', cid.bytes.length);
                    
                    if (cid.bytes.length >= 2) {
                        const version = cid.bytes[0];
                        const codec = cid.bytes[1];
                        const multihash = cid.bytes.slice(2);
                        console.log('Generated CID version:', version);
                        console.log('Generated CID codec:', codec);
                        console.log('Generated CID multihash (hex):', Array.from(multihash).map(b => b.toString(16).padStart(2, '0')).join(''));
                        
                        if (multihash.length >= 2) {
                            const mhCode = multihash[0];
                            const mhSize = multihash[1];
                            const mhDigest = multihash.slice(2);
                            console.log('Generated multihash code:', mhCode);
                            console.log('Generated multihash size:', mhSize);
                            console.log('Generated multihash digest (hex):', Array.from(mhDigest).map(b => b.toString(16).padStart(2, '0')).join(''));
                        }
                    }
                } else {
                    console.log('CID.bytes not available, trying base32 decode...');
                    // Fallback to base32 decoding - decode the full base32 string including 'b' prefix
                    const generatedCidStandardBase32 = generatedCidBase32.toUpperCase();
                    const generatedCidPadded = generatedCidStandardBase32 + '='.repeat((8 - generatedCidStandardBase32.length % 8) % 8);
                    
                    try {
                        // Decode base32 to get raw CID bytes (including header)
                        const generatedCidBytes = new Uint8Array(
                            atob(generatedCidPadded.replace(/-/g, '+').replace(/_/g, '/'))
                                .split('')
                                .map(c => c.charCodeAt(0))
                        );
                        
                        // Convert to hex
                        const generatedCidHex = Array.from(generatedCidBytes).map(b => b.toString(16).padStart(2, '0')).join('');
                        console.log('Generated CID raw bytes (hex):', generatedCidHex);
                        console.log('Generated CID length:', generatedCidBytes.length);
                        
                        if (generatedCidBytes.length >= 2) {
                            const version = generatedCidBytes[0];
                            const codec = generatedCidBytes[1];
                            const multihash = generatedCidBytes.slice(2);
                            console.log('Generated CID version:', version);
                            console.log('Generated CID codec:', codec);
                            console.log('Generated CID multihash (hex):', Array.from(multihash).map(b => b.toString(16).padStart(2, '0')).join(''));
                        }
                    } catch (e) {
                        console.log('Error decoding generated CID:', e);
                    }
                }
                
                // Debug: Output the CID before base32 encoding
                console.log('Generated CID:', cid.toString());
                console.log('Expected CID:', 'bafyreid6gk6me7qotoejyh4tbmohuniu37anfgb6lhr2po3btqannss3dq');
                console.log('CID match:', cid.toString() === 'bafyreid6gk6me7qotoejyh4tbmohuniu37anfgb6lhr2po3btqannss3dq' ? '‚úÖ' : '‚ùå');
                
                // Debug: Check if the issue is in CID generation or base32 encoding
                console.log('CID version:', cid.version);   
                console.log('CID codec:', cid.code);
                console.log('CID multihash:', cid.multihash);
                console.log('CID multihash code:', cid.multihash.code);
                console.log('CID multihash size:', cid.multihash.size);
                console.log('CID multihash digest (hex):', Array.from(cid.multihash.digest).map(b => b.toString(16).padStart(2, '0')).join(''));
                
            } catch (error) {
                console.error('Error generating DID:PLC ID:', error);
                throw new Error('Failed to generate DID:PLC ID: ' + error.message);
            }
            
            // Get base32 representation of CID
            const cidBase32 = cid.toString(base32);
            
            // Debug: Output base32 encoding details
            console.log('CID base32:', cidBase32);
            console.log('Expected base32 for CID bafyreid6gk6me7qotoejyh4tbmohuniu37anfgb6lhr2po3btqannss3dq:');
            
            // Extract the base32 part (remove 'b' prefix and '=' padding)
            const base32Part = cidBase32.substring(1).replace(/=/g, '');
            
            // Debug: Output base32 part
            console.log('Base32 part (no prefix/padding):', base32Part);
            console.log('Base32 part length:', base32Part.length);
            
            // Take first 24 characters for DID:PLC ID
            const didPlcId = base32Part.substring(0, 24);
            
            // Debug: Output DID:PLC ID extraction
            console.log('Extracted DID:PLC ID (first 24 chars):', didPlcId);
            console.log('Expected DID:PLC ID: pyzlzqt6b2nyrha7smfry6rv');
            
            return `did:plc:${didPlcId}`;
        }

        // Make functions globally accessible for onclick handlers
        window.generateKey = generateKey;
        window.copyKey = copyKey;
        window.copyMnemonic = copyMnemonic;
        window.copyPublicKey = copyPublicKey;
        window.copyDidKey = copyDidKey;
        window.restoreFromMnemonic = restoreFromMnemonic;
        window.clearInput = clearInput;
        window.testDidPlcIdGeneration = testDidPlcIdGeneration;

        // Add event listeners
        document.getElementById('generateBtn').addEventListener('click', generateKey);
        document.getElementById('copyBtn').addEventListener('click', copyKey);
        document.getElementById('copyMnemonicBtn').addEventListener('click', copyMnemonic);
        document.getElementById('copyPublicKeyBtn').addEventListener('click', copyPublicKey);
        document.getElementById('copyDidKeyBtn').addEventListener('click', copyDidKey);
        document.getElementById('restoreBtn').addEventListener('click', restoreFromMnemonic);
        document.getElementById('clearBtn').addEventListener('click', clearInput);

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab pane
            document.getElementById(tabName + '-pane').classList.add('active');
            
            // Add active class to selected tab button
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Add tab event listeners
        document.getElementById('keygen-tab').addEventListener('click', () => switchTab('keygen'));
        document.getElementById('didplc-tab').addEventListener('click', () => switchTab('didplc'));
        document.getElementById('createaccount-tab').addEventListener('click', () => switchTab('createaccount'));

        // DID:PLC form handling
        let currentPlcEntry = null;

        function createDidPlcEntry(formData) {
            const entry = {
                "@context": ["https://www.w3.org/ns/did/v1"],
                "id": formData.did,
                "rotationKeys": getRotationKeys(),
                "verificationMethods": {
                    "atproto": formData.atprotoVerificationMethod
                },
                "alsoKnownAs": getAlsoKnownAs(),
                "services": {
                    "atproto_pds": {
                        "type": "AtprotoPersonalDataServer",
                        "endpoint": formData.pdsEndpoint
                    }
                }
            };

            // Add previous update if provided
            if (formData.previousUpdate && formData.previousUpdate.trim()) {
                entry.previousUpdate = formData.previousUpdate.trim();
            }

            return entry;
        }

        function displayPlcResult(entry) {
            const resultDiv = document.getElementById('plc-result');
            const resultContent = document.getElementById('plc-result-content');
            
            resultContent.textContent = JSON.stringify(entry, null, 2);
            resultDiv.style.display = 'block';
            
            // Scroll to result
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        async function copyPlcResult() {
            if (!currentPlcEntry) return;

            try {
                await navigator.clipboard.writeText(JSON.stringify(currentPlcEntry, null, 2));
                const status = getCurrentStatusElement();
                status.innerHTML = '<div class="status success">üìã DID:PLC entry copied to clipboard!</div>';
                
                // Clear status after 3 seconds
                setTimeout(() => {
                    if (status) {
                        status.innerHTML = '';
                    }
                }, 3000);
            } catch (error) {
                console.error('Error copying DID:PLC entry to clipboard:', error);
                const status = getCurrentStatusElement();
                status.innerHTML = '<div class="status error">‚ùå Failed to copy DID:PLC entry to clipboard</div>';
            }
        }

        function clearPlcForm() {
            document.getElementById('didplc-form').reset();
            document.getElementById('plc-result').style.display = 'none';
            currentPlcEntry = null;
            const status = getCurrentStatusElement();
            if (status) {
                status.innerHTML = '';
            }
            
            // Reset rotation keys to single input
            const container = document.getElementById('rotation-keys-container');
            container.innerHTML = '';
            
            const group = document.createElement('div');
            group.className = 'rotation-key-group';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'rotation-key-input';
            input.placeholder = 'Enter rotation key';
            input.required = true;
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-rotation-key-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.style.display = 'none';
            removeBtn.addEventListener('click', function() {
                removeRotationKey(this);
            });
            
            group.appendChild(input);
            group.appendChild(removeBtn);
            container.appendChild(group);
            
            // Reset also known as to single input
            const alsoKnownAsContainer = document.getElementById('also-known-as-container');
            alsoKnownAsContainer.innerHTML = '';
            
            const alsoKnownAsGroup = document.createElement('div');
            alsoKnownAsGroup.className = 'also-known-as-group';
            
            const alsoKnownAsInput = document.createElement('input');
            alsoKnownAsInput.type = 'text';
            alsoKnownAsInput.className = 'also-known-as-input';
            alsoKnownAsInput.placeholder = 'Enter alternative identifier (e.g., at://goat.navy)';
            
            const alsoKnownAsRemoveBtn = document.createElement('button');
            alsoKnownAsRemoveBtn.type = 'button';
            alsoKnownAsRemoveBtn.className = 'remove-also-known-as-btn';
            alsoKnownAsRemoveBtn.textContent = 'Remove';
            alsoKnownAsRemoveBtn.style.display = 'none';
            alsoKnownAsRemoveBtn.addEventListener('click', function() {
                removeAlsoKnownAs(this);
            });
            
            alsoKnownAsGroup.appendChild(alsoKnownAsInput);
            alsoKnownAsGroup.appendChild(alsoKnownAsRemoveBtn);
            alsoKnownAsContainer.appendChild(alsoKnownAsGroup);
        }
        
        function addRotationKey() {
            const container = document.getElementById('rotation-keys-container');
            const newGroup = document.createElement('div');
            newGroup.className = 'rotation-key-group';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'rotation-key-input';
            input.placeholder = 'Enter rotation key';
            input.required = true;
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-rotation-key-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.addEventListener('click', function() {
                removeRotationKey(this);
            });
            
            newGroup.appendChild(input);
            newGroup.appendChild(removeBtn);
            container.appendChild(newGroup);
            
            // Show remove buttons if there are multiple inputs
            updateRemoveButtons();
        }
        
        function removeRotationKey(button) {
            const group = button.parentElement;
            const container = document.getElementById('rotation-keys-container');
            
            // Don't remove if it's the only input
            if (container.children.length > 1) {
                group.remove();
                updateRemoveButtons();
            }
        }
        
        function updateRemoveButtons() {
            const container = document.getElementById('rotation-keys-container');
            const removeButtons = container.querySelectorAll('.remove-rotation-key-btn');
            
            removeButtons.forEach(button => {
                button.style.display = container.children.length > 1 ? 'block' : 'none';
            });
        }
        
        function getRotationKeys() {
            const inputs = document.querySelectorAll('.rotation-key-input');
            return Array.from(inputs)
                .map(input => input.value.trim())
                .filter(value => value !== '');
        }
        
        function setRotationKeys(keys) {
            console.log('setRotationKeys called with:', keys);
            const container = document.getElementById('rotation-keys-container');
            console.log('Container found:', container);
            
            // Clear existing inputs
            container.innerHTML = '';
            
            // Add inputs for each key
            keys.forEach((key, index) => {
                console.log(`Adding key ${index}:`, key);
                const group = document.createElement('div');
                group.className = 'rotation-key-group';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'rotation-key-input';
                input.placeholder = 'Enter rotation key';
                input.required = true;
                input.value = key;
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-rotation-key-btn';
                removeBtn.textContent = 'Remove';
                removeBtn.addEventListener('click', function() {
                    removeRotationKey(this);
                });
                
                group.appendChild(input);
                group.appendChild(removeBtn);
                container.appendChild(group);
            });
            
            // If no keys, add one empty input
            if (keys.length === 0) {
                console.log('No keys provided, adding empty input');
                addRotationKey();
            }
            
            updateRemoveButtons();
            console.log('setRotationKeys completed');
        }
        
        function addAlsoKnownAs() {
            const container = document.getElementById('also-known-as-container');
            const newGroup = document.createElement('div');
            newGroup.className = 'also-known-as-group';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'also-known-as-input';
            input.placeholder = 'Enter alternative identifier (e.g., at://goat.navy)';
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-also-known-as-btn';
            removeBtn.textContent = 'Remove';
            removeBtn.addEventListener('click', function() {
                removeAlsoKnownAs(this);
            });
            
            newGroup.appendChild(input);
            newGroup.appendChild(removeBtn);
            container.appendChild(newGroup);
            
            // Show remove buttons if there are multiple inputs
            updateAlsoKnownAsRemoveButtons();
        }
        
        function removeAlsoKnownAs(button) {
            const group = button.parentElement;
            const container = document.getElementById('also-known-as-container');
            
            // Don't remove if it's the only input
            if (container.children.length > 1) {
                group.remove();
                updateAlsoKnownAsRemoveButtons();
            }
        }
        
        function updateAlsoKnownAsRemoveButtons() {
            const container = document.getElementById('also-known-as-container');
            const removeButtons = container.querySelectorAll('.remove-also-known-as-btn');
            
            removeButtons.forEach(button => {
                button.style.display = container.children.length > 1 ? 'block' : 'none';
            });
        }
        
        function getAlsoKnownAs() {
            const inputs = document.querySelectorAll('.also-known-as-input');
            return Array.from(inputs)
                .map(input => input.value.trim())
                .filter(value => value !== '');
        }
        
        function setAlsoKnownAs(entries) {
            const container = document.getElementById('also-known-as-container');
            
            // Clear existing inputs
            container.innerHTML = '';
            
            // Add inputs for each entry
            entries.forEach((entry, index) => {
                const group = document.createElement('div');
                group.className = 'also-known-as-group';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'also-known-as-input';
                input.placeholder = 'Enter alternative identifier (e.g., at://goat.navy)';
                input.value = entry;
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-also-known-as-btn';
                removeBtn.textContent = 'Remove';
                removeBtn.addEventListener('click', function() {
                    removeAlsoKnownAs(this);
                });
                
                group.appendChild(input);
                group.appendChild(removeBtn);
                container.appendChild(group);
            });
            
            // If no entries, add one empty input
            if (entries.length === 0) {
                addAlsoKnownAs();
            }
            
            updateAlsoKnownAsRemoveButtons();
        }

        // Add DID:PLC form event listeners
        document.getElementById('didplc-form').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            try {
                currentPlcEntry = createDidPlcEntry(data);
                displayPlcResult(currentPlcEntry);
                
                const status = getCurrentStatusElement();
                status.innerHTML = '<div class="status success">‚úÖ DID:PLC entry created successfully!</div>';
            } catch (error) {
                console.error('Error creating DID:PLC entry:', error);
                const status = getCurrentStatusElement();
                status.innerHTML = '<div class="status error">‚ùå Error creating DID:PLC entry. Please check your input.</div>';
            }
        });

        document.getElementById('clear-plc-btn').addEventListener('click', clearPlcForm);
        document.getElementById('copy-plc-result-btn').addEventListener('click', copyPlcResult);
        document.getElementById('copy-plc-debug-btn').addEventListener('click', copyPlcDebug);

        // Create Account form handling
        document.getElementById('createaccount-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const status = getCurrentStatusElement();
            
            // Check if a private key has been generated or loaded
            if (!currentKey) {
                if (status) {
                    status.innerHTML = '<div class="status error">‚ö†Ô∏è No private key available! Please generate a new key or restore one from a mnemonic in the "Generate Key" tab first.</div>';
                }
                return;
            }
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            try {
                // Create DID:PLC operation using current key data
                const didPlcOperation = {
                    "type": "plc_operation",
                    "rotationKeys": [currentDidKey], // Use the current DID key as rotation key
                    "verificationMethods": {
                        "atproto": currentDidKey
                    },
                    "alsoKnownAs": [`at://${data.handle}`], // Use the handle as alsoKnownAs
                    "services": {
                        "atproto_pds": {
                            "type": "AtprotoPersonalDataServer",
                            "endpoint": data.pdsEndpoint
                        }
                    },
                    "prev": null, // null for creation operations
                    "sig": "placeholder_signature" // TODO: Add actual signature
                };
                
                // Generate DID:PLC ID from the operation
                const didPlcId = await generateDidPlcId(didPlcOperation);
                
                // Output to console
                console.log('Generated DID:PLC Operation:', didPlcOperation);
                console.log('DID:PLC ID:', didPlcId);
                console.log('Private Key:', currentKey);
                console.log('Public Key:', currentPublicKey);
                console.log('DID Key:', currentDidKey);
                
                // Update the DID:PLC field in the form
                document.getElementById('account-did').value = didPlcId;
                
                if (status) {
                    status.innerHTML = '<div class="status success">‚úÖ DID:PLC operation created! Check console for details. (Not submitted to directory yet)</div>';
                }
            } catch (error) {
                console.error('Error creating account:', error);
                if (status) {
                    status.innerHTML = '<div class="status error">‚ùå Error creating account. Please check your input.</div>';
                }
            }
        });

        document.getElementById('clear-createaccount-btn').addEventListener('click', function() {
            document.getElementById('createaccount-form').reset();
            document.getElementById('createaccount-result').style.display = 'none';
            const status = getCurrentStatusElement();
            if (status) {
                status.innerHTML = '';
            }
        });

        document.getElementById('copy-createaccount-result-btn').addEventListener('click', function() {
            // TODO: Implement copy functionality
            console.log('Copy account details clicked');
        });

        // DID:PLC fetching functionality
        async function fetchDidPlcRecord(didPlc) {
            const url = `https://plc.directory/${didPlc}/log/audit`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const auditLog = await response.json();
                
                // Get the latest (current) record from the audit log
                if (auditLog.length === 0) {
                    throw new Error('No records found in audit log');
                }
                
                const latestRecord = auditLog[auditLog.length - 1];
                const operation = latestRecord.operation;
                
                // Extract the DID document data from the operation
                console.log('Latest record operation:', operation);
                console.log('Operation rotation keys:', operation.rotationKeys);
                
                const didDocument = {
                    id: latestRecord.did,
                    rotationKeys: operation.rotationKeys,
                    verificationMethods: operation.verificationMethods,
                    services: operation.services,
                    alsoKnownAs: operation.alsoKnownAs,
                    previousRotationKey: latestRecord.operation.prev
                };
                
                console.log('Extracted DID document:', didDocument);
                
                return { didDocument, auditLog };
            } catch (error) {
                console.error('Failed to fetch DID document:', error);
                throw error;
            }
        }

        function populateFormFromDidDocument(didDocument) {
            try {
                console.log('Received DID document:', didDocument);
                
                // Populate DID identifier
                if (didDocument.id) {
                    document.getElementById('plc-did').value = didDocument.id;
                    console.log('Set DID id:', didDocument.id);
                }

                // Populate rotation keys - check multiple possible field names
                let rotationKeys = didDocument.rotationKeys || didDocument.rotationKey || didDocument.rotation_keys || didDocument.rotation_keys_uri;
                let rotationKeyStrings = [];
                
                if (rotationKeys) {
                    console.log('Found rotation keys:', rotationKeys);
                    if (Array.isArray(rotationKeys)) {
                        // Handle array of objects or strings
                        rotationKeyStrings = rotationKeys.map(key => {
                            if (typeof key === 'object' && key !== null) {
                                // If it's an object, try to extract useful information
                                if (key.id) return key.id;
                                if (key.publicKeyMultibase) return key.publicKeyMultibase;
                                if (key.publicKey) return key.publicKey;
                                return JSON.stringify(key);
                            }
                            return key.toString();
                        });
                        console.log('Set rotation keys (array):', rotationKeyStrings);
                    } else {
                        rotationKeyStrings = [rotationKeys.toString()];
                        console.log('Set rotation keys (single):', rotationKeys);
                    }
                } else {
                    // Check if rotation keys are embedded in verification methods
                    if (didDocument.verificationMethod && Array.isArray(didDocument.verificationMethod)) {
                        const rotationKeyMethods = didDocument.verificationMethod.filter(method => 
                            method.type === 'EcdsaSecp256k1RecoveryMethod2020' || 
                            method.type === 'EcdsaSecp256k1VerificationKey2019' ||
                            method.purpose && method.purpose.includes('rotation')
                        );
                        if (rotationKeyMethods.length > 0) {
                            rotationKeyStrings = rotationKeyMethods.map(method => {
                                if (method.publicKeyMultibase) return method.publicKeyMultibase;
                                if (method.publicKey) return method.publicKey;
                                return JSON.stringify(method);
                            });
                            console.log('Set rotation keys from verification methods:', rotationKeyStrings);
                        }
                    }
                }
                
                // Set rotation keys using the new function
                console.log('About to set rotation keys:', rotationKeyStrings);
                setRotationKeys(rotationKeyStrings);

                // Populate ATProto verification method
                let verificationMethods = didDocument.verificationMethods || didDocument.verificationMethod || didDocument.verification_methods || didDocument.verification_method;
                if (verificationMethods) {
                    console.log('Found verification methods:', verificationMethods);
                    
                    if (typeof verificationMethods === 'object' && verificationMethods !== null) {
                        // Handle object format like {"atproto": "did:key:..."}
                        if (verificationMethods.atproto) {
                            document.getElementById('plc-atproto-verification-method').value = verificationMethods.atproto;
                            console.log('Set ATProto verification method:', verificationMethods.atproto);
                        } else {
                            console.log('No atproto key found in verification methods object');
                        }
                    } else if (Array.isArray(verificationMethods)) {
                        // Handle array format (fallback)
                        const methodStrings = verificationMethods.map(method => {
                            if (typeof method === 'object' && method !== null) {
                                if (method.id) return method.id;
                                if (method.type) return `${method.type}: ${method.publicKeyMultibase || method.publicKey || JSON.stringify(method)}`;
                                return JSON.stringify(method);
                            }
                            return method.toString();
                        });
                        // For arrays, take the first method as ATProto verification method
                        if (methodStrings.length > 0) {
                            document.getElementById('plc-atproto-verification-method').value = methodStrings[0];
                            console.log('Set ATProto verification method (from array):', methodStrings[0]);
                        }
                    } else {
                        // Handle string format (fallback)
                        document.getElementById('plc-atproto-verification-method').value = verificationMethods.toString();
                        console.log('Set ATProto verification method (string):', verificationMethods);
                    }
                }

                // Populate PDS endpoint
                let services = didDocument.services || didDocument.service || didDocument.service_endpoints;
                if (services) {
                    console.log('Found services:', services);
                    
                    if (typeof services === 'object' && services !== null) {
                        // Handle object format like {"atproto_pds": {"type": "AtprotoPersonalDataServer", "endpoint": "https://..."}}
                        if (services.atproto_pds && services.atproto_pds.endpoint) {
                            document.getElementById('plc-pds-endpoint').value = services.atproto_pds.endpoint;
                            console.log('Set PDS endpoint:', services.atproto_pds.endpoint);
                        } else {
                            console.log('No atproto_pds.endpoint found in services object');
                        }
                    } else if (Array.isArray(services)) {
                        // Handle array format (fallback)
                        const serviceStrings = services.map(service => {
                            if (typeof service === 'object' && service !== null) {
                                if (service.id) return service.id;
                                if (service.type && service.serviceEndpoint) return `${service.type}: ${service.serviceEndpoint}`;
                                return JSON.stringify(service);
                            }
                            return service.toString();
                        });
                        // For arrays, take the first service as PDS endpoint
                        if (serviceStrings.length > 0) {
                            document.getElementById('plc-pds-endpoint').value = serviceStrings[0];
                            console.log('Set PDS endpoint (from array):', serviceStrings[0]);
                        }
                    } else {
                        // Handle string format (fallback)
                        document.getElementById('plc-pds-endpoint').value = services.toString();
                        console.log('Set PDS endpoint (string):', services);
                    }
                }

                // Populate also known as
                if (didDocument.alsoKnownAs && Array.isArray(didDocument.alsoKnownAs)) {
                    setAlsoKnownAs(didDocument.alsoKnownAs);
                    console.log('Set alsoKnownAs:', didDocument.alsoKnownAs);
                } else {
                    // If no alsoKnownAs or not an array, set empty
                    setAlsoKnownAs([]);
                    console.log('No alsoKnownAs found or not an array');
                }

                // Populate previous update
                let previousUpdate = didDocument.previousRotationKey || didDocument.previous_rotation_key || didDocument.previousUpdate;
                if (previousUpdate) {
                    document.getElementById('plc-previous-update').value = previousUpdate;
                    console.log('Set previous update:', previousUpdate);
                }

                // Log all available fields for debugging
                console.log('All available fields in DID document:', Object.keys(didDocument));
                console.log('Raw DID document data:', didDocument);
                console.log('Field values found:');
                console.log('- id:', didDocument.id);
                console.log('- rotationKeys:', didDocument.rotationKeys);
                console.log('- rotationKey:', didDocument.rotationKey);
                console.log('- rotation_keys:', didDocument.rotation_keys);
                console.log('- rotation_keys_uri:', didDocument.rotation_keys_uri);
                console.log('- verificationMethods:', didDocument.verificationMethods);
                console.log('- verificationMethod:', didDocument.verificationMethod);
                console.log('- verification_methods:', didDocument.verification_methods);
                console.log('- verification_method:', didDocument.verification_method);
                console.log('- services:', didDocument.services);
                console.log('- service:', didDocument.service);
                console.log('- service_endpoints:', didDocument.service_endpoints);
                console.log('- alsoKnownAs:', didDocument.alsoKnownAs);
                console.log('- previousUpdate:', didDocument.previousUpdate);
                console.log('- previous_rotation_key:', didDocument.previous_rotation_key);
                
                // Log all available fields for debugging
                console.log('All available fields in DID document:', Object.keys(didDocument));

                return true;
            } catch (error) {
                console.error('Error populating form:', error);
                return false;
            }
        }

        async function handleFetchDidRecord() {
            const didInput = document.getElementById('plc-did');
            const fetchBtn = document.getElementById('fetch-did-btn');
            const status = getCurrentStatusElement();
            
            const didPlc = didInput.value.trim();
            
            if (!didPlc) {
                status.innerHTML = '<div class="status error">‚ùå Please enter a DID:PLC address first</div>';
                return;
            }

            if (!didPlc.startsWith('did:plc:')) {
                status.innerHTML = '<div class="status error">‚ùå Please enter a valid DID:PLC address (must start with "did:plc:")</div>';
                return;
            }

            // Show loading state
            fetchBtn.disabled = true;
            fetchBtn.textContent = 'üîÑ Fetching...';
            status.innerHTML = '<div class="status success">üîÑ Fetching DID:PLC record from plc.directory...</div>';

            try {
                const { didDocument, auditLog } = await fetchDidPlcRecord(didPlc);
                
                // Show raw audit log for debugging
                const debugDiv = document.getElementById('plc-debug');
                const debugContent = document.getElementById('plc-debug-content');
                debugContent.textContent = JSON.stringify(auditLog, null, 2);
                debugDiv.style.display = 'block';
                
                if (populateFormFromDidDocument(didDocument)) {
                    status.innerHTML = '<div class="status success">‚úÖ DID:PLC record fetched and form populated successfully!</div>';
                } else {
                    status.innerHTML = '<div class="status error">‚ö†Ô∏è Record fetched but some fields could not be populated</div>';
                }
                
                // Clear any existing result
                document.getElementById('plc-result').style.display = 'none';
                currentPlcEntry = null;
                
            } catch (error) {
                console.error('Error fetching DID:PLC record:', error);
                status.innerHTML = `<div class="status error">‚ùå Failed to fetch DID:PLC record: ${error.message}</div>`;
                
                // Hide debug section on error
                document.getElementById('plc-debug').style.display = 'none';
            } finally {
                // Reset button state
                fetchBtn.disabled = false;
                fetchBtn.textContent = 'üîç Fetch Record';
            }
        }

        async function copyPlcDebug() {
            const debugContent = document.getElementById('plc-debug-content');
            if (!debugContent.textContent) return;

            try {
                await navigator.clipboard.writeText(debugContent.textContent);
                const status = getCurrentStatusElement();
                status.innerHTML = '<div class="status success">üìã Raw DID document copied to clipboard!</div>';
                
                // Clear status after 3 seconds
                setTimeout(() => {
                    if (status) {
                        status.innerHTML = '';
                    }
                }, 3000);
            } catch (error) {
                console.error('Error copying raw DID document to clipboard:', error);
                const status = getCurrentStatusElement();
                status.innerHTML = '<div class="status error">‚ùå Failed to copy raw DID document to clipboard</div>';
            }
        }

        // Add event listener for fetch button
        document.getElementById('fetch-did-btn').addEventListener('click', handleFetchDidRecord);
        
        // Add event listeners for rotation key buttons
        document.getElementById('add-rotation-key-btn').addEventListener('click', addRotationKey);
        
        // Add event listener for the initial remove button
        const initialRemoveBtn = document.querySelector('.remove-rotation-key-btn');
        if (initialRemoveBtn) {
            initialRemoveBtn.addEventListener('click', function() {
                removeRotationKey(this);
            });
        }
        
        // Add event listeners for also known as buttons
        document.getElementById('add-also-known-as-btn').addEventListener('click', addAlsoKnownAs);
        
        // Add event listener for the initial also known as remove button
        const initialAlsoKnownAsRemoveBtn = document.querySelector('.remove-also-known-as-btn');
        if (initialAlsoKnownAsRemoveBtn) {
            initialAlsoKnownAsRemoveBtn.addEventListener('click', function() {
                removeAlsoKnownAs(this);
            });
        }

        // Check if Web Crypto API is available
        if (!window.crypto || !window.crypto.getRandomValues) {
            document.getElementById('keyDisplay').textContent = 'Web Crypto API not supported in this browser';
            document.getElementById('generateBtn').disabled = true;
        }

        // Run test case on page load
        testDidPlcIdGeneration();
    </script>
</body>
</html>
